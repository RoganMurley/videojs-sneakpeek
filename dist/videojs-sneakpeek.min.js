"use strict";Object.defineProperty(exports,"__esModule",{value:true});var _extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n){if(Object.prototype.hasOwnProperty.call(n,r)){e[r]=n[r]}}}return e};exports.enablePlugin=enablePlugin;exports.default=sneakpeek;var _video=require("video.js");var _video2=_interopRequireDefault(_video);var _window=require("global/window");var _window2=_interopRequireDefault(_window);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}var defaults={width:0,height:0,basePath:""};function enablePlugin(e,t){var n=_video2.default.registerPlugin||_video2.default.plugin;n(e,t)}function getComputedStyle(e,t){return function(n){if(_window2.default.getComputedStyle){return _window2.default.getComputedStyle(e,t)[n]}return e.currentStyle[n]}}function offsetParent(e){if(e.nodeName!=="HTML"&&getComputedStyle(e)("position")==="static"){return offsetParent(e.offsetParent)}return e}function getScrollOffset(){if(_window2.default.pageXOffset){return{x:_window2.default.pageXOffset,y:_window2.default.pageYOffset}}return{x:document.documentElement.scrollLeft,y:document.documentElement.scrollTop}}function parseImageLink(e){var t=e.indexOf("#");if(t===-1){return{src:e,x:0,y:0,w:0,h:0}}var n=e.substring(0,t);var r=e.substring(t+1);if(r.substring(0,5)!=="xywh="){return{src:defaults.basePath+n,x:0,y:0,w:0,h:0}}var a=r.substring(5).split(",");return{src:defaults.basePath+n,x:+a[0],y:+a[1],w:+a[2],h:+a[3]}}function sneakpeek(e){defaults.basePath=e.basePath||defaults.basePath;var t=_extends({},defaults,e);var n=this;var r=[],a=void 0;n.ready(function(){r=n.remoteTextTracks();o();if(!a){r.addEventListener("addtrack",o)}});function o(){if(a){return}for(var e=0;e<r.length;e++){if(r[e].kind==="metadata"){a=r[e];a.mode="hidden";break}}if(!a){return}if(navigator.userAgent.toLowerCase().indexOf("android")!==-1){var o=n.controlBar.progressControl;var i=function e(){o.addClass("fake-active")};var s=function e(){o.removeClass("fake-active")};o.on("touchstart",i);o.on("touchend",s);o.on("touchcancel",s)}var u=document.createElement("div");u.className="vjs-sneakpeek-holder";var l=document.createElement("img");u.appendChild(l);l.className="vjs-sneakpeek";var d=n.duration();n.on("durationchange",function(){d=n.duration()});n.on("loadedmetadata",function(){d=n.duration()});var f=n.controlBar.progressControl;f.el().appendChild(u);function c(e){var r=getScrollOffset().x;var o=offsetParent(f.el()).getBoundingClientRect();var i=e.pageX;if(e.changedTouches){i=e.changedTouches[0].pageX}var s=(o.width||o.right)+r;var c=i||e.clientX+document.body.scrollLeft+document.documentElement.scrollLeft;c-=offsetParent(f.el()).getBoundingClientRect().left+r;var v=Math.floor((c-f.el().offsetLeft)/f.width()*d);var h=a&&a.cues.length;var g=0;var p=void 0;while(g<h){var w=a.cues[g];if(w.startTime<=v&&w.endTime>=v){p=parseImageLink(w.text);break}g++}if(typeof p==="undefined"){return}if(p.src&&l.src!==p.src){var m="";if(p.src[0]==="/"){m=n.currentSrc();m=m.substring(0,m.lastIndexOf("/"))}l.src=m+p.src}p.w=p.w||t.width;p.h=p.h||t.height;if(u.style.width!==p.w||u.style.height!==p.h){u.style.width=p.w+"px";u.style.height=p.h+"px"}l.style.left=-p.x+"px";l.style.top=-p.y+"px";var y=[p.y,p.w+p.x,p.y+p.h,p.x];l.style.clip="rect("+y.join("px,")+"px)";var x=p.w;var _=x/2;if(c+_>s){c=s-x}else if(c<_){c=0}else{c=c-_}u.style.left=c+"px"}function v(){u.style.left="-1000px"}f.on("mousemove",c);f.on("touchmove",c);f.on("mouseout",v);f.on("touchcancel",v);f.on("touchend",v);n.on("userinactive",v)}}